---
import Layout from '../layouts/Layout.astro';
import { getSession, ADMIN_GITHUB_USERNAME } from '../lib/auth';

const session = await getSession(Astro);

// Redirect to login if not authenticated
if (!session) {
  return Astro.redirect('/login?redirect=/admin');
}

// Check if user is admin
const username = (session.user as any)?.username;
if (username !== ADMIN_GITHUB_USERNAME) {
  return Astro.redirect('/');
}
---

<Layout title="Admin">
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Manage podcast episodes</p>
    </div>

    <div id="episodes-list" class="episodes-list">
      <div class="loading">Loading episodes...</div>
    </div>
  </div>
</Layout>

<script>
  interface EpisodeWithMeta {
    id: string;
    title: string;
    authors: string;
    year: number;
    audioUrl: string;
    transcriptUrl: string | null;
    audioSize: number | null;
    audioUpdated: string | null;
    transcriptSize: number | null;
    transcriptUpdated: string | null;
  }

  function formatBytes(bytes: number | null): string {
    if (bytes === null || bytes === undefined) return 'N/A';
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  function formatDate(dateString: string | null): string {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  async function loadEpisodes() {
    const list = document.getElementById('episodes-list') as HTMLElement;

    try {
      const response = await fetch('/api/admin/episodes');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load episodes');
      }

      const episodes: EpisodeWithMeta[] = data.episodes || [];

      if (episodes.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <p>No episodes found.</p>
          </div>
        `;
        return;
      }

      list.innerHTML = episodes.map(ep => `
        <div class="episode-card" data-id="${ep.id}">
          <div class="episode-header">
            <h3 class="episode-title">${ep.title}</h3>
            <span class="episode-year">${ep.year}</span>
          </div>
          <p class="episode-authors">${ep.authors}</p>

          <div class="file-info">
            <div class="file-row">
              <span class="file-label">Audio:</span>
              <span class="file-size">${formatBytes(ep.audioSize)}</span>
              <span class="file-date">${formatDate(ep.audioUpdated)}</span>
            </div>
            <div class="file-row">
              <span class="file-label">Transcript:</span>
              <span class="file-size">${formatBytes(ep.transcriptSize)}</span>
              <span class="file-date">${formatDate(ep.transcriptUpdated)}</span>
            </div>
          </div>

          <div class="episode-actions">
            <button class="btn btn-regenerate" data-id="${ep.id}" onclick="regenerateAudio('${ep.id}')">
              Regenerate Audio
            </button>
          </div>
        </div>
      `).join('');

    } catch (error) {
      list.innerHTML = `
        <div class="error-state">
          <p>Failed to load episodes: ${error instanceof Error ? error.message : 'Unknown error'}</p>
          <button onclick="loadEpisodes()" class="btn btn-secondary">Retry</button>
        </div>
      `;
    }
  }

  async function regenerateAudio(episodeId: string) {
    const btn = document.querySelector(`button[data-id="${episodeId}"]`) as HTMLButtonElement;
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Regenerating...';

    try {
      const response = await fetch(`/api/admin/episodes/${episodeId}/regenerate-audio`, {
        method: 'POST',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to regenerate audio');
      }

      btn.textContent = 'Queued!';
      btn.classList.add('btn-success');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
        btn.disabled = false;
      }, 3000);

    } catch (error) {
      btn.textContent = 'Failed';
      btn.classList.add('btn-error');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-error');
        btn.disabled = false;
      }, 3000);

      console.error('Regeneration error:', error);
    }
  }

  // Make functions available globally
  (window as any).loadEpisodes = loadEpisodes;
  (window as any).regenerateAudio = regenerateAudio;

  // Initial load
  loadEpisodes();
</script>

<style>
  .admin-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .admin-header {
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--text-secondary);
    margin: 0;
  }

  .episodes-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .loading, .empty-state, .error-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
  }

  .error-state .btn {
    margin-top: 1rem;
  }

  .episode-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .episode-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.25rem;
  }

  .episode-title {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary);
    flex: 1;
    padding-right: 1rem;
  }

  .episode-year {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .episode-authors {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0 0 1rem 0;
  }

  .file-info {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1rem;
  }

  .file-row {
    display: grid;
    grid-template-columns: 80px 80px 1fr;
    gap: 0.5rem;
    font-size: 0.75rem;
    padding: 0.25rem 0;
  }

  .file-row:not(:last-child) {
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .file-label {
    color: var(--text-secondary);
    font-weight: 500;
  }

  .file-size {
    color: var(--text-primary);
    font-family: monospace;
  }

  .file-date {
    color: var(--text-secondary);
    text-align: right;
  }

  .episode-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: none;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .btn-regenerate {
    background: var(--accent);
    color: white;
  }

  .btn-regenerate:hover:not(:disabled) {
    background: var(--accent-hover);
  }

  .btn-regenerate:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-success {
    background: #22c55e !important;
  }

  .btn-error {
    background: #ef4444 !important;
  }

  .btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--bg-secondary);
  }
</style>
